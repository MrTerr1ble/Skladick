{% extends "base.html" %}
{% load static %}
{% block title %}Приёмка руды — Создание{% endblock %}

{% block topbar %}
<div class="topbar">
  <div class="tabs"><div class="tab active">СОЗДАНИЕ</div></div>
  <div class="profile"><a class="btn ghost" href="{% url 'ore:receipt_list' %}">Назад</a></div>
</div>
{% endblock %}

{% block content %}
<div class="container">
  <div class="grid">
    <form method="post" enctype="multipart/form-data" class="card" id="receiptForm">
      {% csrf_token %}
      <div class="toolbar">
        <button class="btn primary" type="submit">СОХРАНИТЬ</button>
        <button class="btn ghost" type="button" onclick="history.back()">ОТМЕНИТЬ</button>
      </div>

      <div class="field">
        <label class="label">Локация</label>
        {{ form.location }}
        {% for error in form.location.errors %}<span class="error-text">{{ error }}</span>{% endfor %}
      </div>
      <div class="field">
        <label class="label">Номенклатура</label>
        {{ form.item }}
        {% for error in form.item.errors %}<span class="error-text">{{ error }}</span>{% endfor %}
      </div>
      <div class="field">
        <label class="label">Вес по данным весов</label>
        {{ form.quantity }}
        {% for error in form.quantity.errors %}<span class="error-text">{{ error }}</span>{% endfor %}
      </div>
      <div class="field">
        <label class="label">Документ</label>
        {{ form.contract }}
        {% for error in form.contract.errors %}<span class="error-text">{{ error }}</span>{% endfor %}
      </div>
      <div class="field">
        <label class="label">Примечание</label>
        {{ form.note }}
        {% for error in form.note.errors %}<span class="error-text">{{ error }}</span>{% endfor %}
      </div>
      <div class="field">
        <label class="label">Файл</label>
        {{ form.file }}
        {% for error in form.file.errors %}<span class="error-text">{{ error }}</span>{% endfor %}
      </div>

      {% if form.non_field_errors %}
        <div class="field">
          <div class="input error">
            {{ form.non_field_errors }}
          </div>
        </div>
      {% endif %}
    </form>

    <div class="preview" id="previewBox">
      предпросмотр документа
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // живой предпросмотр
  const form = document.getElementById('receiptForm');
  const preview = document.getElementById('previewBox');
  function renderPreview(){
    const loc = form.querySelector('[name="location"]')?.selectedOptions[0]?.textContent || '—';
    const item = form.querySelector('[name="item"]')?.selectedOptions[0]?.textContent || '—';
    const qty = form.querySelector('#f_quantity')?.value || '—';
    const doc = form.querySelector('#f_contract')?.value || '—';
    const note = form.querySelector('#f_note')?.value || '—';
    const file = form.querySelector('#f_file')?.files?.[0]?.name || '—';
    preview.innerHTML = `
      <div style="text-align:left; max-width:520px">
        <h3 style="margin-top:0">Акт приёмки (черновик)</h3>
        <p><strong>Локация:</strong> ${loc}</p>
        <p><strong>Номенклатура:</strong> ${item}</p>
        <p><strong>Вес:</strong> ${qty}</p>
        <p><strong>Документ:</strong> ${doc}</p>
        <p><strong>Примечание:</strong> ${note}</p>
        <p><strong>Файл:</strong> ${file}</p>
      </div>`;
  }
  form.addEventListener('input', renderPreview);
  form.addEventListener('change', renderPreview);
  renderPreview();
</script>
{% endblock %}
